usage()
{
    echo "Usage: $0: [-v 18|20] [-t <m|p>] [-n <name>] [-p <1|0>] [-s <server>] [-u <dbuser> ] [-w <dbpass>] [-d <1|0>] [-h] [--] [script options]"
    echo "Options:"
    echo -e "\t-v\t\tversion (18 for 1.8 and 20 for 2.0)"
    echo -e "\t-t\t\tserver database type (m = mysql, p = postgresql)"
    echo -e "\t-y\t\tproxy database type (m = mysql, p = postgresql, s = sqlite (proxy only)"
    echo -e "\t-p\t\tenable proxy (1 - yes, 0 - no)"
    echo -e "\t-n <dbname>\tspecify database name"
    echo -e "\t-u <dbuser>\tspecify db user"
    echo -e "\t-w <dbpass>\tspecify db password"
    echo -e "\t-a <path>\tspecify WEB address"
    echo -e "\t-r <path>\tspecify URL path"
    echo -e "\t-s <server>\tspecify db server host"
    echo -e "\t-c <directory>\tspecify configuration files directory (default: /etc/zabbix)"
    echo -e "\t-l <directory>\tspecify log and pid files directory (default: /tmp)"
    echo -e "\t-d\t\tenable debug (1 - yes, 0 - no)"
    echo -e "\t-h, --help\tthis help message"
    if type additional_usage &>/dev/null; then
	additional_usage
    fi
    if type script_usage &>/dev/null; then
	echo "Script options:"
	script_usage
    fi
    exit 1
}

dbg()
{
    [ "$O_DEBUG" = "1" ] || return
    echo "DBG: $*"
}

msg()
{
    echo "MSG: $*"
}

err()
{
    echo "ERR: $*"
    exit 1
}

eval_defaults()
{
    n=0
    dbg "script: $0"
    while [ $n -lt ${#defaults[*]} ]; do
	o=${defaults[$n]}
	((n+=2))
	v=$(/bin/grep "$o=" $ZBX_DEFAULTS | sed "s|^$o=\([^[:space:]]*\).*$|\1|")
	eval export $o=$v
	dbg "$o=$v"
    done
}

write_defaults()
{
    n=0
    while [ $n -lt ${#defaults[*]} ]; do
	o=${defaults[$n]}
	((n++))
	v=${defaults[$n]}
	((n++))
	/bin/grep -q "$o=" $ZBX_DEFAULTS 2>/dev/null || write_default $o $v
    done
}

write_default()
{
    o=$1
    v=$2

    # return if already set
    /bin/grep -q "^$o=$v$" $ZBX_DEFAULTS 2>/dev/null && return

    # add entry if missing
    if ! /bin/grep -q "^$o=" $ZBX_DEFAULTS 2>/dev/null; then
	echo $o=$v >> $ZBX_DEFAULTS
	return;
    fi

    # replace otherwise
    sed -i "s|^$o=.*|$o=$v|" $ZBX_DEFAULTS
}

recompile()
{
	local target=$1

	msg "running conf.sh $O_ARGS -- -t $target"
	conf.sh $O_ARGS -- -t $target >/dev/null || exit
#	msg "cleaning up"
#	make clean > /dev/null || exit
	msg "running make dbschema"
	make dbschema >/dev/null || exit
	msg "running make -j2 install >/dev/null"
	make -j2 install >/dev/null || exit
}

exec_sql()
{
    db_name="$1"
    shift
    cmd="$1"
    shift

    CMD=

    if [ "p" = "$O_DB" ]; then
        ADDOPTS=
	[ "$O_DEBUG" = "1" ] && ADDOPTS="-a"
	export PGPASSWORD=$O_DBPASS
	CMD="psql $ADDOPTS -h $DBHost -v ON_ERROR_STOP=1 -q -U $O_DBUSER"
    elif [ "m" = "$O_DB" ]; then
        ADDOPTS=
	[ "$O_DEBUG" = "1" ] && ADDOPTS="-v"
	CMD="mysql $ADDOPTS -h $DBHost -u $O_DBUSER -p$O_DBPASS"
#	CMD="mysql $ADDOPTS -u $O_DBUSER -p$O_DBPASS -t"
    else
	echo unsupported db type: $O_DB
	exit
    fi

    msg="[$O_DB:$O_DBUSER@$O_DBHOST"
    [ -n "$db_name" ] && msg="$msg:$db_name"
    msg="$msg] $cmd"

    >&2 echo $msg

    $CMD "$@"
}

set_ini()
{
	local file=$1
	local section=$2
	local key=$3
	local value=$4

	echo "[$section] $key = $value"

	sed -i -r "/\[$section\]/,/\[/ s,^($key.*=).*,\1 $value," $file
}

ZBX_RETVAL=
fix_db_name()
{
    ZBX_RETVAL=$(echo $1 | tr -- -./ _ | tr [A-Z] [a-z])
}

remote_url=$(git config --get remote.origin.url)

if [ -z "$remote_url" ]; then
	echo "cannot identify git repository, is \"$(pwd)\" a git repo directory?"
	exit 1
fi

REPO=$(basename -s .git $remote_url)

if [ -z "$REPO" ]; then
	echo "cannot identify git repository, is \"$(pwd)\" a git repo directory?"
	exit 1
fi

BRANCH=$(git describe --exact-match --tags $(git log -n1 --pretty='%h') 2>&1)

if [ $? -eq 0 ]; then
	BRANCH="tag-$BRANCH"
else
	BRANCH=$(git branch | grep '^*' | awk '{print $2}')

	if [ -z "$BRANCH" ]; then
		echo "something impossible just happened"
		exit -1
	fi
fi

defaults=(
    O_DEBUG		0		# debug enabled (NB! THIS ENTRY SHOULD BE FIRST)
    O_VER		20		# Zabbix version (2.0)
    O_DB		m		# server DB type (MySQL)
    O_DBPRX		s		# proxy DB type (SQLite)
    O_DBUSER		zabbix		# DB user
    O_DBPASS		password	# DB password
    O_DBHOST		localhost	# DB host
    O_DBNAME		""		# DB name
    O_PRX_DBNAME	""		# proxy DB name
    O_PRX		0		# proxy enabled
    O_ZCONFDIR		/etc/zabbix	# configuration files directory
    O_ZLOGDIR		/tmp		# log and pid files directory
    O_WEBADDR           "127.0.0.1"	# WEB address
    O_URLPATH           ""		# base URL path to zabbix
)

# remember initial command-line args
O_ARGS="$*"

# file with defaults
ZBX_DEFAULTS="$(dirname $0)/.zbx-defaults"

DB_PREFIX=dimir
fix_db_name ${REPO}_${BRANCH}
DB_POSTFIX=$ZBX_RETVAL

EMAIL=vladimir.levijev@zabbix.com

write_defaults

stop=0
while [ -n "$1" ]; do
    case "$1" in
        -v)
            shift
	    case $1 in
		"18"|"20")
		    write_default O_VER $1
		    ;;
		*)
		    usage
		    ;;
	    esac
            ;;
        -t)
            shift
	    case $1 in
		"p"|"m")
		    write_default O_DB $1
		    ;;
		*)
		    err "currently supported only m (MySQL) and p (PostgreSQL) server DB types"
		    ;;
	    esac
            ;;
        -y)
            shift
	    case $1 in
		"p"|"m"|"s")
		    write_default O_DBPRX $1
		    ;;
		*)
		    err "currently supported only m (MySQL), p (PostgreSQL) and s (SQLite) proxy DB types"
		    ;;
	    esac
            ;;
        -n)
            shift
	    write_default O_DBNAME $1
            ;;
        -a)
            shift
            write_default O_WEBADDR $1
            ;;
        -r)
            shift
            write_default O_URLPATH $1
            ;;
        -p)
	    shift
	    p=
	    if [ "$1" = "1" ]; then
		p=1
	    elif [ "$1" = "0" ]; then
		p=0
	    else
		err "option -p requires parameter"
	    fi
	    write_default O_PRX $p
            ;;
        -s)
            shift
	    write_default O_DBHOST $1
	    ;;
        -u)
            shift
	    write_default O_DBUSER $1
	    ;;
        -w)
            shift
	    write_default O_DBPASS $1
	    ;;
        -c)
            shift
	    [ -z "$1" -o ! -d "$1" ] && err "invalid configuration directory ($1)"
	    write_default O_ZCONFDIR $1
            ;;
        -l)
            shift
	    [ -z "$1" -o ! -d "$1" ] && err "invalid log and pid files directory specified"
	    write_default O_ZLOGDIR $1
	    ;;
        -d)
	    shift
	    d=0
	    [ -n "$1" -a "$1" != "0" ] && d=1
	    write_default O_DEBUG $d
            ;;
        --)
	    shift
	    # stop parsing args
	    break
	    ;;
        -*)
            usage
            ;;
        *)
	    stop=1
            break
            ;;
    esac
    [ $stop -eq 1 ] && break
    shift
done

eval_defaults

DBHost=$O_DBHOST

DBName=
if [ -n "$O_DBNAME" ]; then
    DBName=$O_DBNAME
else
    DBName=${DB_PREFIX}_$DB_POSTFIX
fi

write_default O_DBNAME $DBName

PRX_DBName=
if [ $O_PRX -eq 1 ]; then
	if [ $O_DBPRX = "s" ]; then
		PRX_DBName="/var/lib/sqlite/${DBName}_prx.sqlite3"
	else
		PRX_DBName="${DBName}_prx"
	fi
fi

write_default O_PRX_DBNAME $PRX_DBName

DBUser=$O_DBUSER
DBPassword=$O_DBPASS
